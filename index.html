<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Importar Plano</title>

<link rel="icon" href="data:,">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0b1228;
  --card:rgba(255,255,255,.07);
  --st:rgba(255,255,255,.12);
  --tx:#eef1ff;
  --mut:rgba(238,241,255,.7);
  --b1:#ff5a2a;
  --b2:#ff8a2a;
}
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#070a14,var(--bg));
  color:var(--tx);
  padding:16px;
}
.card{
  max-width:900px;
  margin:0 auto;
  background:var(--card);
  border:1px solid var(--st);
  border-radius:18px;
  padding:16px;
}
h1{margin:0 0 6px;font-size:18px}
p{margin:0 0 14px;color:var(--mut)}
label{font-size:12px;color:var(--mut)}
input,button{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid var(--st);
  background:rgba(255,255,255,.06);
  color:var(--tx);
  font-size:14px;
}
button{
  cursor:pointer;
  background:linear-gradient(135deg,var(--b1),var(--b2));
  border:0;
  font-weight:900;
  margin-top:10px;
}
.danger{background:#ef4444}
.row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.log{
  white-space:pre-wrap;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.1);
  padding:12px;
  border-radius:12px;
  margin-top:12px;
  min-height:110px;
}
</style>
</head>

<body>
<div class="card">
  <h1>Admin — Importar Plano de Expedição</h1>
  <p>Importa o CSV do dia para o Supabase.</p>

  <div class="row">
    <div>
      <label>Data do plano</label>
      <input id="dataPlano" type="date"/>
    </div>
    <div>
      <label>Arquivo CSV</label>
      <input id="file" type="file" accept=".csv"/>
    </div>
  </div>

  <button id="btnImport">IMPORTAR</button>
  <button id="btnClear" class="danger">LIMPAR PLANO DO DIA</button>

  <div class="log" id="log">Aguardando…</div>
</div>

<script>
(function(){

  const SUPABASE_URL = "https://rwzxuiudrbhkfrzxjpyt.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3enh1aXVkcmJoa2ZyenhqcHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Mzg4NzIsImV4cCI6MjA4NzExNDg3Mn0.jFRgHPWZ8yTAHzXegxCI9s28NlUVyDPF67WmToWSg3g";

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession:false, autoRefreshToken:false }
  });

  const el = id => document.getElementById(id);
  const log = t => el("log").textContent = t;

  el("dataPlano").valueAsDate = new Date();

  function detectSep(line){
    return (line.includes(";") && !line.includes(",")) ? ";" : ",";
  }

  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(l=>l.trim());
    const sep = detectSep(lines[0]);
    const headers = lines.shift().toLowerCase().split(sep);

    const idxID = headers.indexOf("id");
    const idxLetras = headers.findIndex(h=>h.includes("letra"));

    if(idxID < 0 || idxLetras < 0){
      throw new Error("CSV precisa conter colunas ID e LETRA(S)");
    }

    return lines.map(l=>{
      const c = l.split(sep).map(x=>x.trim());
      return {
        id_motorista: c[idxID],
        letras: c[idxLetras]
      };
    }).filter(r=>r.id_motorista && r.letras);
  }

  el("btnImport").onclick = async ()=>{
    try{
      const file = el("file").files[0];
      if(!file) return log("Selecione um CSV.");

      const data_plano = el("dataPlano").value;
      if(!data_plano) return log("Escolha a data.");

      log("Lendo CSV...");
      const text = await file.text();
      const rows = parseCSV(text).map(r=>({...r, data_plano}));

      log("Limpando plano anterior...");
      await sb.rpc("limpar_plano_do_dia",{p_data:data_plano});

      log("Inserindo dados...");
      const { error } = await sb.from("plano_expedicao").insert(rows);
      if(error) return log("Erro: "+error.message);

      log("Importado com sucesso ✅");
    }
    catch(e){
      log("Erro: "+e.message);
    }
  };

  el("btnClear").onclick = async ()=>{
    const data_plano = el("dataPlano").value;
    if(!data_plano) return log("Escolha a data.");

    log("Limpando plano...");
    const { error } = await sb.rpc("limpar_plano_do_dia",{p_data:data_plano});
    if(error) return log("Erro: "+error.message);

    log("Plano limpo ✅");
  };

})();
</script>

</body>
</html>
