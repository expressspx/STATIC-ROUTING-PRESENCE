<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel — Mesas</title>
<link rel="icon" href="data:,">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b1228;--tx:#eef1ff;--mut:rgba(238,241,255,.72);
    --bad:#ef4444;--ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui;background:linear-gradient(180deg,#070a14,var(--bg));color:var(--tx);padding:16px}

  header{display:flex;align-items:end;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  h1{margin:0;font-size:28px;letter-spacing:.3px}
  .mut{color:var(--mut)}
  .small{font-size:13px;color:var(--mut)}
  .err{margin:10px 0;padding:10px 12px;border-radius:12px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.12);display:none;white-space:pre-wrap}

  .grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(320px, 1fr));
    gap:16px;
  }
  @media(max-width:1350px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:620px){.grid{grid-template-columns:1fr}}

  .mesa{
    border-radius:24px;
    border:3px solid rgba(34,197,94,.35);
    background:radial-gradient(1200px 420px at -10% -10%, rgba(34,197,94,.18), transparent 45%),
               rgba(255,255,255,.06);
    box-shadow:0 18px 60px rgba(0,0,0,.35);
    padding:20px;
    min-height:340px;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;
  }
  .mesa.ocupada{
    border-color:rgba(239,68,68,.40);
    background:radial-gradient(1200px 420px at -10% -10%, rgba(239,68,68,.20), transparent 45%),
               rgba(255,255,255,.06);
  }

  .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .title{font-size:44px;font-weight:1000;line-height:1}
  .badge{
    display:inline-flex;align-items:center;gap:10px;
    padding:10px 14px;border-radius:999px;font-weight:1000;font-size:16px;
    border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
  }
  .dot{width:12px;height:12px;border-radius:50%}
  .livre .dot{background:var(--ok)}
  .conf .dot{background:var(--bad)}

  .id{font-size:54px;font-weight:1000;letter-spacing:.5px;line-height:1}
  .nome{font-size:20px;font-weight:950;color:rgba(238,241,255,.95);line-height:1.2}
  .rota{
    font-size:22px;font-weight:1000;line-height:1.15;
    word-break:break-word;
  }

  .chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 14px;border-radius:999px;font-weight:1000;font-size:15px;
    border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
    width:max-content;
  }
  .chip .dot{width:10px;height:10px}
  .moto .dot{background:#60a5fa}
  .fiorino .dot{background:#f59e0b}
  .passeio .dot{background:#34d399}

  .spacer{flex:1}
  .btn{
    width:100%;
    padding:18px 14px;border-radius:18px;
    font-size:24px;font-weight:1000;
    border:0;cursor:pointer;
  }
  .btn.finalizar{background:linear-gradient(135deg,#ff3b3b,#ff7b7b);color:#fff}
  .btn.disabled{background:rgba(255,255,255,.08);color:rgba(238,241,255,.55);cursor:not-allowed}

  /* Modal confirmação */
  .overlay{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;padding:14px;z-index:50;
  }
  .modal{
    width:min(760px,100%);
    border-radius:18px;background:rgba(15,23,42,.95);
    border:1px solid rgba(255,255,255,.12);
    box-shadow:0 24px 70px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .mHead{padding:14px 14px 10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.10)}
  .mHead h2{margin:0;font-size:18px}
  .mBody{padding:14px;display:grid;gap:10px}
  .mActions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;padding:14px;border-top:1px solid rgba(255,255,255,.10)}
  .ghost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--tx);padding:12px 14px;border-radius:14px;font-weight:950;cursor:pointer}
  .danger{background:linear-gradient(135deg,#ff3b3b,#ff7b7b);border:0;color:#fff;padding:12px 14px;border-radius:14px;font-weight:1000;cursor:pointer}
</style>
</head>
<body>

<header>
  <div>
    <h1>Painel — Mesas</h1>
    <div class="small">Ao vivo via Supabase Realtime</div>
  </div>
  <div class="mut" id="info">—</div>
</header>

<div class="err" id="errBox"></div>
<div class="grid" id="grid"></div>

<!-- Modal -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="mHead">
      <h2>Confirmar finalização</h2>
      <button class="ghost" id="btnClose">Fechar</button>
    </div>
    <div class="mBody" id="modalBody"></div>
    <div class="mActions">
      <button class="ghost" id="btnCancel">Cancelar</button>
      <button class="danger" id="btnOk">Sim, finalizar</button>
    </div>
  </div>
</div>

<script>
(()=>{

  const SUPABASE_URL = "https://rwzxuiudrbhkfrzxjpyt.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3enh1aXVkcmJoa2ZyenhqcHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Mzg4NzIsImV4cCI6MjA4NzExNDg3Mn0.jFRgHPWZ8yTAHzXegxCI9s28NlUVyDPF67WmToWSg3g";
  const MESA_COUNT = 14; // aumente aqui quando precisar abrir mais mesas

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth:{ persistSession:false, autoRefreshToken:false }
  });

  const el = id => document.getElementById(id);
  const errBox = el("errBox");

  function showErr(t){ errBox.style.display="block"; errBox.textContent=t; console.error(t); }
  function clearErr(){ errBox.style.display="none"; errBox.textContent=""; }

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function tipoClass(tipo){
    const t = (tipo||"").toUpperCase();
    if(t.includes("FIORINO")) return "fiorino";
    if(t.includes("PASSEIO")) return "passeio";
    if(t.includes("MOTO")) return "moto";
    return "moto";
  }

  function renderMesaCard(m){
    const ocupada = (m.status === "conferindo");
    const nome = m.driver_name || "";
    const tipo = m.tipo_veiculo || "";
    const letras = m.letras || "";
    const tCls = tipoClass(tipo);

    return `
      <div class="mesa ${ocupada ? "ocupada":""}">
        <div class="top">
          <div class="title">Mesa ${m.mesa_id}</div>
          <div class="badge ${ocupada ? "conf":"livre"}">
            <span class="dot"></span>
            ${ocupada ? "CONFERINDO" : "LIVRE"}
          </div>
        </div>

        ${ocupada ? `
          <div class="id">${escapeHTML(m.id_motorista)}</div>
          <div class="nome">${escapeHTML(nome)}</div>
          <div class="chip ${tCls}"><span class="dot"></span>${escapeHTML(tipo || "-")}</div>
          <div class="rota">${escapeHTML(letras)}</div>

          <div class="spacer"></div>
          <button class="btn finalizar" data-fin="1" data-mesa="${m.mesa_id}">FINALIZAR</button>
        ` : `
          <div class="mut" style="font-size:18px;line-height:1.35">
            Aguardando motorista…<br>
            Quando o DASH enviar alguém, aparece aqui automaticamente.
          </div>
          <div class="spacer"></div>
          <button class="btn disabled" disabled>Aguardando</button>
        `}
      </div>
    `;
  }

  async function ensureMesas(){
    const { data, error } = await sb
      .from("mesas_status")
      .select("mesa_id")
      .order("mesa_id", {ascending:true});
    if(error) throw error;

    const set = new Set((data||[]).map(x=>x.mesa_id));
    const inserts = [];
    for(let i=1;i<=MESA_COUNT;i++){
      if(!set.has(i)) inserts.push({ mesa_id:i, status:"livre" });
    }
    if(inserts.length){
      const { error: e2 } = await sb.from("mesas_status").insert(inserts);
      if(e2) throw e2;
    }
  }

  async function carregar(){
    clearErr();
    try{
      await ensureMesas();

      const { data, error } = await sb
        .from("mesas_status")
        .select("mesa_id, status, id_motorista, driver_name, tipo_veiculo, letras")
        .order("mesa_id", { ascending:true });

      if(error) throw error;

      const rows = (data||[]);
      el("grid").innerHTML = rows.map(renderMesaCard).join("");

      const now = new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
      el("info").textContent = `Mesas: ${MESA_COUNT} • Atualizado: ${now}`;

      [...document.querySelectorAll("[data-fin='1']")].forEach(btn=>{
        const mesaId = Number(btn.dataset.mesa);
        btn.onclick = ()=> abrirConfirm(mesaId, rows.find(r=>r.mesa_id===mesaId));
      });

    }catch(e){
      showErr("Erro mesa: " + (e.message || e));
    }
  }

  // Modal confirmação
  let pendingMesa = null;

  function abrirConfirm(mesaId, row){
    pendingMesa = mesaId;
    el("modalBody").innerHTML = `
      <div class="mut">Você tem certeza que deseja <b>FINALIZAR</b>?</div>
      <div style="line-height:1.6;font-size:15px">
        <b>Mesa:</b> ${mesaId}<br>
        <b>Motorista:</b> ${escapeHTML(row?.id_motorista || "-")}<br>
        <b>Nome:</b> ${escapeHTML(row?.driver_name || "-")}<br>
        <b>Tipo:</b> ${escapeHTML(row?.tipo_veiculo || "-")}<br>
        <b>Rota:</b> ${escapeHTML(row?.letras || "-")}<br>
      </div>
      <div class="mut">Isso vai liberar a mesa e marcar como FINALIZADO no DASH.</div>
    `;
    el("overlay").style.display="flex";
  }

  function fecharConfirm(){
    el("overlay").style.display="none";
    pendingMesa = null;
  }

  el("btnClose").onclick = fecharConfirm;
  el("btnCancel").onclick = fecharConfirm;

  el("btnOk").onclick = async ()=>{
    if(!pendingMesa) return;
    try{
      clearErr();
      const { error } = await sb.rpc("finalizar_mesa", { p_mesa_id: pendingMesa });
      if(error) return showErr("Erro ao finalizar: " + error.message);
      fecharConfirm();
      await carregar();
    }catch(e){
      showErr("Erro ao finalizar: " + (e.message || e));
    }
  };

  function subscribe(){
    sb.channel("rt-mesas")
      .on("postgres_changes", { event:"*", schema:"public", table:"mesas_status" }, ()=>carregar())
      .subscribe();

    sb.channel("rt-checkins")
      .on("postgres_changes", { event:"*", schema:"public", table:"checkins" }, ()=>carregar())
      .subscribe();
  }

  carregar();
  subscribe();
})();
</script>
</body>
</html>
